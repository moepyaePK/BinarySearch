name: CodeQL Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security-analysis:
    name: Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd backend
          npm install
      
      - name: Check for SQL Injection
        run: |
          echo "üîç Checking for SQL injection vulnerabilities..."
          
          # Check for unsafe string concatenation in SQL queries
          if grep -r "SELECT.*FROM.*WHERE.*=.*\${" backend/ --include="*.js"; then
            echo "‚ùå SQL Injection vulnerability found: String interpolation in SQL query"
            exit 1
          fi
          
          if grep -r "SELECT.*FROM.*WHERE.*=.*+" backend/ --include="*.js" | grep -v "?"; then
            echo "‚ùå SQL Injection vulnerability found: String concatenation in SQL query"
            exit 1
          fi
          
          echo "‚úÖ No SQL injection patterns detected"
      
      - name: Check for Hardcoded Credentials
        run: |
          echo "üîç Checking for hardcoded credentials..."
          
          # Check for hardcoded passwords/secrets (excluding .env files)
          if grep -r "password.*=.*['\"][^$]" backend/ --include="*.js" | grep -v "process.env" | grep -v ".env"; then
            echo "‚ùå Hardcoded credentials found"
            exit 1
          fi
          
          echo "‚úÖ No hardcoded credentials detected"
      
      - name: Verify Environment Variables Usage
        run: |
          echo "üîç Verifying environment variables are used..."
          
          # Check that DB credentials use environment variables
          if ! grep -q "process.env.DB_HOST" backend/**/*.js; then
            echo "‚ùå DB_HOST should use environment variable"
            exit 1
          fi
          
          if ! grep -q "process.env.DB_USER" backend/**/*.js; then
            echo "‚ùå DB_USER should use environment variable"
            exit 1
          fi
          
          if ! grep -q "process.env.DB_PASSWORD" backend/**/*.js; then
            echo "‚ùå DB_PASSWORD should use environment variable"
            exit 1
          fi
          
          echo "‚úÖ Environment variables are properly used"
      
      - name: Check for Parameterized Queries
        run: |
          echo "üîç Checking for parameterized queries..."
          
          # Verify parameterized queries are used
          if ! grep -q 'db.query.*\[.*\]' backend/routes/users.js; then
            echo "‚ùå Parameterized queries not found in users.js"
            exit 1
          fi
          
          echo "‚úÖ Parameterized queries detected"
